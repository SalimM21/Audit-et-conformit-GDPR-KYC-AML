apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: logging
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki.logging.svc.cluster.local:3100/loki/api/v1/push

    scrape_configs:
      # ===== LOGS APPLICATIONS =====
      - job_name: scoring-api
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="scoring-api"}'
              stages:
                - json:
                    expressions:
                      level: level
                      timestamp: timestamp
                      message: message
                      request_id: request_id
                      user_id: user_id
                      model_version: model_version
                - labels:
                    level:
                    component: scoring-api
                    request_id:
                    user_id:
                    model_version:
                - timestamp:
                    format: RFC3339
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - action: replace
            replacement: scoring-api
            target_label: job

      - job_name: api-gateway
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="api-gateway"}'
              stages:
                - regex:
                    expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<message>.+)$'
                - labels:
                    level:
                    component: api-gateway
                - timestamp:
                    format: "2006-01-02 15:04:05"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: api-gateway
            target_label: job

      - job_name: mlflow
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="mlflow"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) (?P<level>\w+) in (?P<logger>[\w\.]+): (?P<message>.+)'
                - labels:
                    level:
                    logger:
                    component: mlflow
                - timestamp:
                    format: "2006-01-02 15:04:05,000"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: mlflow
            target_label: job

      # ===== LOGS INFRASTRUCTURE =====
      - job_name: kafka
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="kafka"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) (?P<level>\w+) \[(?P<thread>[^\]]+)\] (?P<logger>[^\s]+) - (?P<message>.+)'
                - labels:
                    level:
                    thread:
                    logger:
                    component: kafka
                - timestamp:
                    format: "2006-01-02 15:04:05,000"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: kafka
            target_label: job

      - job_name: postgresql
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="postgresql"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) (?P<pid>\d+) (?P<level>\w+)  (?P<message>.+)'
                - labels:
                    level:
                    pid:
                    component: postgresql
                - timestamp:
                    format: "2006-01-02 15:04:05.000"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: postgresql
            target_label: job

      - job_name: redis
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="redis"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d+:\d+:\d+) (?P<role>\w+) (?P<message>.+)'
                - labels:
                    role:
                    component: redis
                - timestamp:
                    format: "15:04:05"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: redis
            target_label: job

      # ===== LOGS MONITORING =====
      - job_name: prometheus
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="prometheus"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) (?P<level>\w+) (?P<message>.+)'
                - labels:
                    level:
                    component: prometheus
                - timestamp:
                    format: "2006/01/02 15:04:05"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: prometheus
            target_label: job

      - job_name: grafana
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="grafana"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z) (?P<level>\w+) (?P<logger>[^\s]+) (?P<message>.+)'
                - labels:
                    level:
                    logger:
                    component: grafana
                - timestamp:
                    format: RFC3339
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: grafana
            target_label: job

      # ===== LOGS SÉCURITÉ =====
      - job_name: keycloak
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="keycloak"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) (?P<level>\w+) \[(?P<class>[^\]]+)\] \((?P<method>[^\)]+)\) (?P<message>.+)'
                - labels:
                    level:
                    class:
                    method:
                    component: keycloak
                - timestamp:
                    format: "2006-01-02 15:04:05,000"
                    source: timestamp
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - action: replace
            replacement: keycloak
            target_label: job

      # ===== LOGS CONTAINERS GÉNÉRIQUES =====
      - job_name: kubernetes-containers
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - cri: {}
          - labeldrop:
              - filename
              - stream
          - pack:
              labels:
                - component
                - namespace
                - pod_name
                - container_name
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod_name
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_container_name]
            target_label: container_name
          - action: replace
            replacement: kubernetes-containers
            target_label: job

      # ===== LOGS EVENTS KUBERNETES =====
      - job_name: kubernetes-events
        kubernetes_sd_configs:
          - role: event
        pipeline_stages:
          - json:
              expressions:
                involvedObject: involvedObject
                reason: reason
                message: message
                source: source
                firstTimestamp: firstTimestamp
                lastTimestamp: lastTimestamp
                count: count
                type: type
          - labels:
              reason:
              type:
              component: kubernetes-events
          - timestamp:
              format: RFC3339
              source: firstTimestamp
        relabel_configs:
          - action: replace
            replacement: kubernetes-events
            target_label: job
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
  namespace: logging
spec:
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      serviceAccountName: promtail
      containers:
      - name: promtail
        image: grafana/promtail:2.9.0
        ports:
        - containerPort: 9080
          name: http
        args:
        - -config.file=/etc/promtail/promtail.yaml
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: varlogcontainers
          mountPath: /var/log/containers
          readOnly: true
        - name: varlogpods
          mountPath: /var/log/pods
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: config
        configMap:
          name: promtail-config
      - name: varlogcontainers
        hostPath:
          path: /var/log/containers
      - name: varlogpods
        hostPath:
          path: /var/log/pods
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: promtail
  namespace: logging
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: promtail
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs: ["get", "list", "watch"]
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs: ["get"]
- nonResourceURLs: ["/metrics"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: promtail
subjects:
- kind: ServiceAccount
  name: promtail
  namespace: logging
roleRef:
  kind: ClusterRole
  name: promtail
  apiGroup: rbac.authorization.k8s.io